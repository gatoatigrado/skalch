<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>~/sandbox/skalch/base/src/test/scala/cuda/Histogram.scala.html</title>
<meta name="Generator" content="Vim/7.2">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#ffffff" text="#000000"><font face="monospace">
<font color="#a020f0">package</font>&nbsp;cuda<br>
<font color="#a020f0">import</font>&nbsp;skalch._<br>
<font color="#a020f0">import</font>&nbsp;skalch.cuda._<br>
<font color="#a020f0">import</font>&nbsp;skalch.cuda.annotations._<br>
<font color="#a020f0">import</font>&nbsp;sketch.util._<br>
<br>
<font color="#0000ff">/**</font><br>
<font color="#0000ff">&nbsp;* accumulate things in the histogram</font><br>
<font color="#0000ff">&nbsp;* </font><font color="#6a5acd">@author</font><font color="#0000ff">&nbsp;gatoatigrado (nicholas tung) [email: ntung at ntung]</font><br>
<font color="#0000ff">&nbsp;* </font><font color="#6a5acd">@license</font><font color="#0000ff">&nbsp;This file is licensed under BSD license, available at</font><br>
<font color="#0000ff">&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://creativecommons.org/licenses/BSD/">http://creativecommons.org/licenses/BSD/</a>. While not required,</font><br>
<font color="#0000ff">&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if you make changes, please consider contributing back!</font><br>
<font color="#0000ff">&nbsp;*/</font><br>
<font color="#a52a2a"><b>class</b></font>&nbsp;<font color="#6a5acd">Histogram</font>() <font color="#a52a2a"><b>extends</b></font>&nbsp;<font color="#6a5acd">CudaKernel</font>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>type</b></font>&nbsp;<font color="#6a5acd">Word</font>&nbsp;= <font color="#6a5acd">Int</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>type</b></font>&nbsp;<font color="#6a5acd">IntArr</font>&nbsp;= <font color="#6a5acd">ScIArray1D</font><font color="#6a5acd">[IntPtr]</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>type</b></font>&nbsp;<font color="#6a5acd">WordArr</font>&nbsp;= <font color="#6a5acd">ScIArray1D</font><font color="#6a5acd">[Word]</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>class</b></font>&nbsp;<font color="#6a5acd">Sentence</font>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;en&nbsp;:<font color="#2e8b57"><b>&nbsp;WordArr</b></font>&nbsp;@ <font color="#6a5acd">ArrayLen</font>(<font color="#ff00ff">40</font>) @ scIField = <font color="#a52a2a"><b>null</b></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;fr&nbsp;:<font color="#2e8b57"><b>&nbsp;WordArr</b></font>&nbsp;@ <font color="#6a5acd">ArrayLen</font>(<font color="#ff00ff">40</font>) @ scIField = <font color="#a52a2a"><b>null</b></font><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>class</b></font>&nbsp;<font color="#6a5acd">BloomFilter</font>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;keys&nbsp;:<font color="#2e8b57"><b>&nbsp;IntArr</b></font>&nbsp;= <font color="#a52a2a"><b>null</b></font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>def</b></font>&nbsp;<font color="#008b8b">increment</font>(idx :<font color="#2e8b57"><b>&nbsp;Int</b></font>, amnt :<font color="#2e8b57"><b>&nbsp;Int</b></font>) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;idx2&nbsp;= <font color="#a52a2a"><b>if</b></font>&nbsp;(idx &lt; <font color="#ff00ff">0</font>) -idx <font color="#a52a2a"><b>else</b></font>&nbsp;idx<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keys(idx2 % keys.length).atomicAdd(amnt)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">/*</font><br>
<br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;struct VLArray_Int {</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int length;</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int *values;</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;}</font><br>
<br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;struct BloomFilter {</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VLArray_Int keys;</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;}</font><br>
<br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;__device__ void increment(int idx, int amnt) {</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int idx2;</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (idx &lt; 0) {</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx2 = -idx;</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;idx2 = idx;</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;atomicAdd(&amp;keys.values[idx2 % keys.length], amnt);</font><br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;}</font><br>
<br>
<font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>def</b></font>&nbsp;<font color="#008b8b">hash1</font>(en :<font color="#2e8b57"><b>&nbsp;Word</b></font>, fr :<font color="#2e8b57"><b>&nbsp;Word</b></font>) = en * <font color="#ff00ff">7130881</font>&nbsp;+ fr * <font color="#ff00ff">240727</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>def</b></font>&nbsp;<font color="#008b8b">hash2</font>(en :<font color="#2e8b57"><b>&nbsp;Word</b></font>, fr :<font color="#2e8b57"><b>&nbsp;Word</b></font>) = en * <font color="#ff00ff">207139</font>&nbsp;+ fr * <font color="#ff00ff">143797</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;@scKernel <font color="#a52a2a"><b>def</b></font>&nbsp;<font color="#008b8b">addToHistogram</font>(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentences :<font color="#2e8b57"><b>&nbsp;ScIArray1D[Sentence]</b></font>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bigram :<font color="#2e8b57"><b>&nbsp;BloomFilter</b></font>&nbsp;@ scCopy)<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>var</b></font>&nbsp;sent_idx&nbsp;= blockIdx.x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>while</b></font>&nbsp;(sent_idx &lt; sentences.length) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;sent&nbsp;= sentences(sent_idx)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>var</b></font>&nbsp;en_idx&nbsp;= threadIdx.x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>while</b></font>&nbsp;(en_idx &lt; sent.en.length) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;en_word&nbsp;= sent.en(en_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(en_word != -<font color="#ff00ff">1</font>) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">// no &quot;break&quot; stmt</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>var</b></font>&nbsp;fr_idx&nbsp;= threadIdx.y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>while</b></font>&nbsp;(fr_idx &lt; sent.fr.length) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>val</b></font>&nbsp;fr_word&nbsp;= sent.fr(fr_idx)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(fr_word != -<font color="#ff00ff">1</font>) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">// no &quot;break&quot; stmt</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bigram.increment(hash1(en_word, fr_word), <font color="#ff00ff">1</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bigram.increment(hash2(en_word, fr_word), <font color="#ff00ff">1</font>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fr_idx += blockDim.y<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;en_idx += blockDim.x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sent_idx += gridDim.x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__syncthreads()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
</font></body>
</html>
